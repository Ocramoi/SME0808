<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="code-eval-mirror_data/code-eval-mirror.css">
</head>
<body class="vsc-initialized">
    <div id="embedContainer"><iframe style="width: 100%; height: 100%;" src="code-eval-mirror_data/reportEmbed.html" scrolling="no" allowfullscreen="true"></iframe></div>
    <script nomodule="" src="code-eval-mirror_data/es6-promise.js"></script>
    <script src="code-eval-mirror_data/powerbi.js"></script>
    <script src="code-eval-mirror_data/powerbi-report-authoring.js"></script>
    <script src="code-eval-mirror_data/models.js"></script>
    <script>
        var embedIframeLoaded = false;
        var pendingMessages = null;
        var mockEmbedConfig = {
            type: 'report',
            embedUrl: 'embedUrl',
            accessToken: 'accessToken',
            id: 'id'
        };
        var playgroundOrigin = 'https://playground.powerbi.com';
        var embedUrlOrigin;
        var allowedFrameSrcList = 'https://app.powerbi.com/reportEmbed https://app.powerbi.cn/reportEmbed'.trim().toLowerCase().split(' ');
        window.addEventListener('message', receiveMessage, false);

        
        function receiveMessage(event) {
            
            var embedContainer = document.getElementById('embedContainer');
            var embedIframe = embedContainer.getElementsByTagName('iframe')[0];

            if (event.data) {
                try {
                    var messageData;
                    try {
                        messageData = JSON.parse(event.data);
                    } catch (e) {
                        messageData = event.data;
                    }

                    if (event.data.source == "code-eval-wrapper" && event.origin === playgroundOrigin && event.source === window.parent) {
                        if (event.data.target == "embedContainer") {
                            
                            if (event.data.method == "appendChild") {
                                
                                if (!isFrameSrcAllowed(event.data.embedUrl))
                                    return;
                                var iframeContent = document.createElement("iframe");
                                iframeContent.style.width = '100%';
                                iframeContent.style.height = '100%';
                                iframeContent.setAttribute("src", event.data.embedUrl);
                                embedUrlOrigin = getUrlOrigin(event.data.embedUrl);
                                iframeContent.setAttribute("scrolling", "no");
                                iframeContent.setAttribute("allowfullscreen", "true");
                                while (embedContainer.firstChild) {
                                    embedContainer.removeChild(embedContainer.firstChild);
                                }

                                embedContainer.appendChild(iframeContent);
                                iframeContent.addEventListener('load', function () {
                                    embedIframeLoaded = true;
                                    handlePendingMessages();
                                    setEventHandlers();

                                    
                                    powerbi.embed(document.getElementById('embedContainer'), mockEmbedConfig);
                                }, false);
                            }
                        }

                        else if (event.data.target == "Embed" && event.data.method == "fullScreen") {
                            report = powerbi.get(embedContainer);
                            report.fullscreen();
                        }

                        else if (event.data.target == "Embed" && event.data.method == "exitFullscreen") {
                            report = powerbi.get(embedContainer);
                            report.exitFullscreen();
                        }

                        else if (event.data.target == "Service" && event.data.method == "reset") {
                            
                            powerbi.reset(embedContainer);
                            embedIframeLoaded = false;
                            window.parent.postMessage({
                                source: "code-eval-mirror",
                                target: "dev-sandbox",
                                method: "powerbi-reset-completed"
                            }, playgroundOrigin);
                        }

                        else if (embedIframeLoaded) {
                            
                            event.data.headers.id = event.data.headers.originalId;
                            embedIframe.contentWindow.postMessage(event.data, embedUrlOrigin);
                        }
                        else {
                            pendingMessages = pendingMessages || [];
                            pendingMessages.push(event.data);
                        }
                        
                    } else if (!messageData.handler && event.origin === embedUrlOrigin && event.source === embedIframe.contentWindow) {
                        window.parent.postMessage(messageData, playgroundOrigin);
                    }
                }
                catch (e) {
                    console.error(e);
                }
            }
        }

        function handlePendingMessages() {
            if (!pendingMessages) {
                return;
            }

            pendingMessages.forEach(pendingMessage => {
                var embedContainer = document.getElementById('embedContainer');
                var embedIframe = embedContainer.getElementsByTagName('iframe')[0];
                embedIframe.contentWindow.postMessage(pendingMessage, embedUrlOrigin);
            });

            setEventHandlers();
            pendingMessages = null;
        }

        function setEventHandlers() {
            
            let serviceClass = window["powerbi-client"].service.Service;
            serviceClass.prototype.handleEvent = function () {
                window.parent.postMessage({
                    source: "code-eval-mirror",
                    target: "Service",
                    method: "handleEvent",
                    args: arguments[0]
                }, playgroundOrigin);
            };

            
            let embedClass = window["powerbi-client"].Embed;
            embedClass.prototype.setIframe = function () {
                var embedContainer = document.getElementById('embedContainer');
                this.iframe = embedContainer.getElementsByTagName('iframe')[0];
            };
        }

        function isFrameSrcAllowed(frameSrc) {
            var frameSrcHostAndPath = frameSrc.split('?')[0];
            return allowedFrameSrcList.includes(frameSrcHostAndPath.toLowerCase());
        }

        function getUrlOrigin(url) {
            return new URL(url).origin;
        }
    </script>

<script src="app.js" type="text/javascript"></script></body></html>